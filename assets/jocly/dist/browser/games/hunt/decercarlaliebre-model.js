exports.model=Model={Game:{},Board:{},Move:{}},Model.Game.HuntInitGame=function(){this.g.huntOptions={compulsoryCatch:!1,catchLongestLine:!1,multipleCatch:!0},this.g.huntEval={pieceCount:1e6,freeZone:100,dist:1e3},this.g.RC=[],this.g.Graph=[],this.g.useDrop=!1,this.g.evaluate0=0,this.g.debugEval=!1},Model.Game.HuntPostInitGame=function(){this.HuntMakeDist(),this.zobrist=new JocGame.Zobrist({board:{type:"array",size:this.g.Graph.length,values:["1","-1"]},who:{values:["1","-1"]}})},Model.Game.HuntMakeGrid=function(t){var e={rows:5,cols:5,row0:0,col0:0,dirs:4};Object.assign(e,t);for(var i={},a=this.g.RC.length,r=0;r<e.rows;r++)for(var s=0;s<e.cols;s++){var h=a+r*e.cols+s;this.g.RC[h]=[r+e.row0,s+e.col0],i[r+","+s]=h}for(var h=0;h<this.g.RC.length;h++){var r=this.g.RC[h][0],s=this.g.RC[h][1],o=[],n=i[r-1+","+s];void 0!==n?o.push(n):o.push(null),n=i[r+1+","+s],void 0!==n?o.push(n):o.push(null),n=i[r+","+(s-1)],void 0!==n?o.push(n):o.push(null),n=i[r+","+(s+1)],void 0!==n?o.push(n):o.push(null);for(var c=o.length;c<e.dirs;c++)o.push(null);this.g.Graph.push(o)}},Model.Game.HuntMakeDist=function(){function t(t,i,a){e.g.Dist[t][i]=a,a>e.g.DistMax&&(e.g.DistMax=a)}var e=this;this.g.Dist=[],this.g.DistMax=0;for(var i=0;i<this.g.Graph.length;i++){for(var a=[],r=0;r<=i;r++)a.push(-1);this.g.Dist.push(a)}for(var s=0;s<this.g.Graph.length;s++)for(var h=this.g.Graph[s],o=0;o<h.length;o++){var n=h[o];null!=n&&(n<s&&this.g.Dist[s-1][n]==-1?t(s-1,n,1):n>s&&this.g.Dist[n-1][s]==-1&&t(n-1,s,1))}for(var c=!0,l=1;c;l++){c=!1;for(var s=1;s<this.g.Graph.length;s++)for(var n=0;n<s;n++)if(this.g.Dist[s-1][n]==l){for(var h=this.g.Graph[n],o=0;o<h.length;o++){var u=h[o];null!=u&&(u<s&&this.g.Dist[s-1][u]==-1?(t(s-1,u,l+1),c=!0):u>s&&this.g.Dist[u-1][s]==-1&&(t(u-1,s,l+1),c=!0))}h=this.g.Graph[s];for(var o=0;o<h.length;o++){var u=h[o];null!=u&&(u<n&&this.g.Dist[n-1][u]==-1?(t(n-1,u,l+1),c=!0):u>n&&this.g.Dist[u-1][n]==-1&&(t(u-1,n,l+1),c=!0))}}}},Model.Game.HuntRemovePositions=function(t){var e={},i=0;t.sort(function(t,e){return t-e});for(var a=0;a<this.g.Graph.length;a++)t.length>0&&a==t[0]?t.shift():e[a]=i++;for(var a=0;a<this.g.Graph.length;a++)if(void 0!==e[a]){for(var r=this.g.Graph[a],s=[],h=0;h<r.length;h++){var o=r[h];null!=o&&void 0!==e[o]?s.push(e[o]):s.push(null)}this.g.Graph[a]=s}else this.g.Graph[a]="X";for(var n=[],c=[],a=0;a<this.g.Graph.length;a++)void 0!==e[a]&&(n.push(this.g.Graph[a]),c.push(this.g.RC[a]));this.g.Graph=n,this.g.RC=c,this.g.PosName={}},Model.Game.HuntDist=function(t,e){if(t==e)return 0;if(e>t){var i=t;t=e,e=i}return this.g.Dist[t-1][e]},Model.Move.Init=function(t){void 0!==t&&this.CopyFrom(t)},Model.Move.PosName={},Model.Move.ToString=function(){function t(t){if(void 0!==e[t]&&e[t].length>0){var i=[];for(var a in e[t]){var r=e[t][a];void 0!==e.PosName[r]?i.push(e.PosName[r]):i.push(r)}return i.join(",")}return""}var e=this,i="";i+=t("p");var a=t("c");return a.length>0&&(i+="x"+a),i},Model.Move.Equals=function(t){if(null==t)return!1;if(t.p.length!=this.p.length)return!1;for(var e=0;e<this.p.length;e++)if(t.p[e]!=this.p[e])return!1;if(void 0===t.c&&void 0===this.c)return!0;if(void 0!==t.c&&void 0!==this.c){for(var e=0;e<this.c.length;e++)if(t.c[e]!=this.c[e])return!1;return!0}return!1},Model.Board.InitialPosition=function(t){this.HuntInitialPosition(t,t.g.initialPos),this.zSign=t.zobrist.update(0,"who",-1)},Model.Board.CopyFrom=function(t){this.board=[];for(var e=0;e<t.board.length;e++)this.board.push(null);this.pieces=[];for(var e in t.pieces){var i=t.pieces[e],a={p:i.p,s:i.s,i:i.i,a:i.a,pv:i.pv,pv2:i.pv2};this.pieces.push(a),a.p>-1&&(this.board[a.p]=a)}this.pieceCount=[t.pieceCount[0],t.pieceCount[1]],this.lastMoves={1:[t.lastMoves[1][0],t.lastMoves[1][1],t.lastMoves[1][2]],"-1":[t.lastMoves[-1][0],t.lastMoves[-1][1],t.lastMoves[-1][2]]},this.mWho=t.mWho,this.zSign=t.zSign},Model.Board.HuntInitialPosition=function(t,e){this.board=[];for(var i=0;i<t.g.Graph.length;i++)this.board.push(null);this.pieces=[],this.pieceCount=[0,0];for(var a=0;a<2;a++)for(var r=0;r<e[a].length;r++){var i=e[a][r],s={p:i,s:1-2*a,i:this.pieces.length,a:0};this.board[i]=s,this.zSign=t.zobrist.update(this.zSign,"board",1-2*a,i),this.pieces.push(s),this.pieceCount[a]++}this.lastMoves={1:[null,null,null],"-1":[null,null,null]}},Model.Board.GenerateMoves=function(t){this.mMoves=[],t.g.useDrop&&(this.mMoves=this.HuntGetAllDropMoves(t)),0==this.mMoves.length&&(this.mMoves=this.HuntGetAllMoves(t),0==this.mMoves.length&&(this.mFinished=!0,this.mWinner=-this.mWho))},Model.Board.HuntGetCatcherMoves=function(t){function e(r,s,h,o){for(var n=!1,c=0;c<t.g.Graph[r].length;c++){var l=t.g.Graph[r][c];if(null!=l){var u=i.board[l];if(null!=u&&u.s==-i.mWho){var v=t.g.Graph[l][c];if(null!=v&&(null==i.board[v]||s.indexOf(v)>=0)){for(var p=!0,g=Math.floor(c/2),d=0;d<h.length;d++)if(l==h[d]&&g==o[d]){p=!1;break}if(p){var f=s.concat([v]),M=h.concat([l]);if(0==t.g.huntOptions.multipleCatch)a.push({p:f,c:M}),n=!0;else{0!=e(v,f,M,o.concat([g]))&&0!=t.g.huntOptions.compulsaryCatch||(a.push({p:f,c:M}),n=!0)}}}}}}return n}for(var i=this,a=[],r=0;r<this.pieces.length;r++){var s=this.pieces[r];s.p>=0&&s.s==this.mWho&&e(s.p,[s.p],[],[])}if(0==a.length||0==t.g.huntOptions.compulsaryCatch)a=a.concat(this.HuntGetCatcheeMoves(t));else if(t.g.huntOptions.catchLongestLine){var h=0,o=[];for(var r in a)h<a[r].c.length?(h=a[r].c.length,o=[a[r]]):h==a[r].c.length&&o.push(a[r]);a=o}return a},Model.Board.HuntGetCatcheeMoves=function(t){for(var e=[],i=0;i<this.pieces.length;i++){var a=this.pieces[i];if(a.p>=0&&a.s==this.mWho)for(var r=0;r<t.g.Graph[a.p].length;r++){var s=t.g.Graph[a.p][r];null!=s&&null==this.board[s]&&e.push({p:[a.p,s]})}}return e},Model.Board.HuntGetAllMoves=function(t){return this.mWho==t.g.catcher?this.HuntGetCatcherMoves(t):this.HuntGetCatcheeMoves(t)},Model.Board.HuntGetAllDropMoves=function(t){for(var e=[],i=null,a=0;a<this.pieces.length;a++){var r=this.pieces[a];if(r.p==-2&&r.s==this.mWho){i=r;break}}if(i)for(var s=0;s<this.board.length;s++)null==this.board[s]&&e.push({p:[s]});return e},Model.Board.HuntMakeEvalData=function(t){for(var e={catcher:t.g.catcher,catchee:-t.g.catcher,catcherSide:(1-t.g.catcher)/2,catcheeSide:(t.g.catcher+1)/2,catcherPieces:[],catcheePieces:[],catcherPiecesDock:[],catcheePiecesDock:[]},i=0;i<this.pieces.length;i++){var a=this.pieces[i];a.p>-1?a.s==e.catcher?e.catcherPieces.push(a):e.catcheePieces.push(a):a.p==-2&&(a.s==e.catcher?e.catcherPiecesDock.push(a):e.catcheePiecesDock.push(a))}return e},Model.Board.HuntEvaluateFreeZone=function(t,e,i){var a={},r=-1;for(var s in e.catcherPieces){var h=e.catcherPieces[s],o={},n=0,c={},l=1;for(c[h.p]=!0;l>0;){var u;for(var v in c){u=parseInt(v),l--;break}delete c[u],o[u]=!0,n++,a[u]=!0;for(var p in t.g.Graph[u]){var g=t.g.Graph[u][p];null==g||null!=this.board[g]||o[g]||c[g]||(c[g]=!0,l++)}}(r<0||r<n-1)&&(r=n-1,o)}e.catcherZone=a,i.freeZone=[r,0],i.freeZone2=[r*r,0],i.freeZoneSQRT=[Math.sqrt(r),0];var d=0,f=0,M=0;for(var s in e.catcheePieces){var m=e.catcheePieces[s],G=0;for(var u in o){var p=t.HuntDist(u,m.p);p>G&&(G=p),p>M&&(M=p)}d+=G,f+=G*G}i.distFree=[d,0],i.distFree2=[f,0],i.maxDistFree=[M,0]},Model.Board.HuntEvaluateOppositeDistFromCatcher=function(t,e,i){var a=[];for(var r in e.catcherPieces){for(var s=e.catcherPieces[r],h=[],o=0,n=0;n<t.g.Graph.length;n++){var c=t.HuntDist(n,s.p);c>o?(o=c,h=[n]):c==o&&h.push(n)}a=a.concat(h)}var c=0,l=0,u=0;for(var r in e.catcheePieces){for(var s=e.catcheePieces[r],v=0,p=0,g=0,d=0;d<a.length;d++)d0=t.HuntDist(a[d],s.p),v+=d0,p+=d0*d0,g+=Math.sqrt(v);c+=v/h.length,l+=p/h.length,u+=g/h.length}i.oppDist=[-c,0],i.oppDist2=[-l,0],i.oppDists=[-u,0]},Model.Board.HuntEvaluateDistToCatcher=function(t,e,i){var a=0,r=0,s=0,h=0;for(var o in e.catcheePieces){var n=e.catcheePieces[o],c=-1;for(var l in e.catcherPieces){var u=e.catcherPieces[l],v=t.HuntDist(u.p,n.p);(c<0||c<v)&&(c=v)}a+=c;var p=c*c;r+=p,s+=c*p,c>h&&(h=c)}i.dist3=[s,0],i.dist2=[r,0],i.dist=[a,0],i.maxDist=[h,0]},Model.Board.HuntEvaluateCatchable=function(t,e,i){var a=0,r=0,s=0;for(var h in e.catcheePieces){for(var o=e.catcheePieces[h],n=o.p,c=!1,l=!1,u=t.g.Graph[n],v=0;v<u.length;v+=2){var p=u[v],g=u[v+1];null!=p&&null!=g&&(null==this.board[p]&&null==this.board[g]?(r++,c=!0):(null==this.board[p]&&this.board[g].s==t.g.catcher||null==this.board[g]&&this.board[p].s==t.g.catcher)&&(r++,l=!0,c=!0))}c&&a++,l&&s++}i.catchablePieces=[a,0],i.catchableDir=[r,0],i.catchableDir2=[r*r,0],i.catchDangerFork=[s>1?1:0,0]},Model.Board.HuntEvaluateRisk=function(t,e,i){function a(t){void 0===e.catcherZone[t]&&(void 0===h[t]?(h[t]=1,n++):h[t]++)}function r(t){void 0===s[t]?(s[t]=1,o++):s[t]++}var s={},h={},o=0,n=0;for(var c in e.catcheePieces)for(var l=e.catcheePieces[c],u=l.p,v=t.g.Graph[u],p=0;p<v.length;p+=2){var g=v[p],d=v[p+1];if(null!=g&&null!=d){var f=this.board[g],M=this.board[d];null==f&&null==M?(a(g),a(d)):null!=f&&f.s==t.g.catcher&&null==M?(a(g),r(d)):null!=M&&M.s==t.g.catcher&&null==f&&(r(g),a(d))}}var m=0;for(var u in h){var G=h[u];m+=G*G}var b=0;for(var u in s){var G=s[u];b+=G*G}i.openRisk=[m,0],i.forkRisk=[b,0]},Model.Board.HuntEvaluateAntiBack=function(t,e,i){var a=0,r=0,s=0,h=0;for(var o in e.catcheePieces){var n=e.catcheePieces[o];n.p==n.pv2&&h++}for(var o in e.catcherPieces){var n=e.catcherPieces[o];n.p==n.pv2&&s++}for(var c=-1;c<2;c+=2){var l=this.lastMoves[c];null!=l[0]&&l[0].Equals(l[2])&&(t.g.catcher==c?a++:r++)}i.antiBack=[r,a],i.antiBackPiece=[h,s]},Model.Board.HuntEvaluateCatcheeConnections=function(t,e,i){for(var a=0,r=0,s=0;s<this.pieces.length;s++){var h=this.pieces[s];if(h.s==-t.g.catcher&&h.p>=0){for(var o=0,n=t.g.Graph[h.p],c=0;c<n.length;c++){var l=n[c];if(null!=l){var u=this.board[l];u&&u.s==h.s&&o++}}a+=o,r+=Math.log(o+1)}}i.catcheeConn=[0,a],i.catcheeConnLog=[0,r]},Model.Board.HuntEvaluateCatcheeGroups=function(t,e,i){for(var a={},r=0,s=0;s<this.pieces.length;s++){var h=this.pieces[s];h.s==-t.g.catcher&&h.p>=0&&(a[h.i]=h,r++)}for(var o=0;r>0;){o++;for(var s in a)break;var h=a[s];delete a[s];var n={};n[s]=h;for(var c=1;c>0;){for(var s in n)break;var l=n[s];delete n[s],c--,delete a[s],r--;for(var u=t.g.Graph[l.p],v=0;v<u.length;v++){var p=u[v];if(null!=p){var g=this.board[p];g&&g.i in a&&!(g.i in n)&&(n[g.i]=g,c++)}}}}i.catcheeGroups=[o,0]},Model.Board.HuntEvaluateGroups=function(t,e,i){for(var a={},r={},s=0,h=0;h<t.g.Graph.length;h++)if(void 0===r[h]){for(var o=this.board[h],n=null,c=t.g.Graph[h],l=0;l<c.length;l++){var u=c[l];if(null!=u){var v=this.board[u];if((null==o&&null==v||null!=o&&null!=v&&o.s==v.s)&&void 0!==r[u]){var p=r[u];if(null==n)r[h]=p,a[p].poss.push(h),n=p;else if(n!=p){var g=a[n],d=a[p];g.poss=g.poss.concat(d.poss);for(var f in d.poss)r[d.poss[f]]=n;delete a[p]}}}}null==n&&(a[s]={type:null==o?0:o.s,poss:[h],touchCatcher:!1},r[h]=s++)}for(var f in e.catcherPieces)for(var o=e.catcherPieces[f],l=0;l<c.length;l++){var u=t.g.Graph[o.p][l];null!=u&&(a[r[u]].touchCatcher=!0)}var M=0,m=0,G=0,b=0;for(var C in a){var g=a[C];g.type==-t.g.catcher?M++:0==g.type&&(0==g.touchCatcher?(g.poss.length>m&&(m=g.poss.length),G+=g.poss.length):1==g.touchCatcher&&(b+=g.poss.length))}i.catcheeGroups=[M,0],i.maxEmptyNoCatcherGroup=[0,m],i.emptyNoCatcherGroup=[0,G],i.minEmptyCatcherGroup=[b<0?0:b,0]},Model.Board.HuntGameEvaluate=function(t,e,i){return{pieceCount:[1,1]}},Model.Board.QuickEvaluate=function(t){return this.Evaluate(t,!1,!0),this.mEvaluation},Model.Board.Evaluate=function(t,e,i){t.GetRepeatOccurence(this)>2&&(this.mFinished=!0,this.mWinner=JocGame.DRAW);var a=this.HuntMakeEvalData(t);if(this.pieceCount[a.catcherSide]<t.g.catcherMin&&(this.mFinished=!0,this.mWinner=a.catchee),this.pieceCount[a.catcheeSide]<t.g.catcheeMin&&(this.mFinished=!0,this.mWinner=a.catcher),this.mEvaluation=0,!this.mFinished){var r={pieceCount:[this.pieceCount[a.catcherSide],this.pieceCount[a.catcheeSide]]},s=this.HuntGameEvaluate(t,a,r),h="debug"==arguments[3];for(var o in s){var n=s[o],c=r[o];void 0===c&&console.error("Evaluation undefined map value",o),h&&console.log(o+":",c[0],"x",n[0]," - ",c[1],"x",n[1],"=",c[0]*n[0]-c[1]*n[1]),this.mEvaluation+=c[0]*n[0]-c[1]*n[1]}if(h){for(var o in r)void 0===s[o]&&JocLog("Unused",o+": ",r[o][0],r[o][1]);JocLog("==>",this.mEvaluation,"=>",this.mEvaluation*t.g.catcher,"=>",this.mEvaluation*t.g.catcher-t.g.evaluate0)}this.mEvaluation*=t.g.catcher,this.mEvaluation-=t.g.evaluate0}},Model.Board.HuntCheckBoard=function(t){for(var e in t.g.Graph){var i=t.g.Graph[e],a=this.board[i];if(null!=a&&a.p!=i)return"Piece "+a+e+" has p "+a.p+" while on board pos "+i}for(var e in this.pieces){var a=this.pieces[e];if(a.p!=-1&&this.board[a.p]!=a)return"Piece "+e+" not on board "+a.p}return null},Model.Board.HuntAngle=function(t,e,i){var a=t.g.RC[e],r=a[0],s=a[1],h=t.g.RC[i],o=h[0],n=h[1],c=0,l=o-r,u=n-s;return 0==l?c=u>0?90:-90:(c=180*Math.atan(u/l)/Math.PI,l<0&&(c=(c+180)%360)),c},Model.Board.ApplyMove=function(t,e){if(1==e.p.length)for(var i=0;i<this.pieces.length;i++){var a=this.pieces[i];if(a.s==this.mWho&&a.p==-2){a.p=e.p[0],a.a=0,this.board[a.p]=a,this.zSign=t.zobrist.update(this.zSign,"board",a.s,a.p);break}}else{var a=this.board[e.p[0]];if(this.zSign=t.zobrist.update(this.zSign,"board",a.s,a.p),this.board[e.p[0]]=null,this.board[e.p[e.p.length-1]]=a,a.pv2=a.pv,a.pv=a.p,a.p=e.p[e.p.length-1],a.a=this.HuntAngle(t,e.p[e.p.length-2],e.p[e.p.length-1]),this.zSign=t.zobrist.update(this.zSign,"board",a.s,a.p),void 0!==e.c)for(var r=this.mWho==JocGame.PLAYER_A?0:1,i=0;i<e.c.length;i++)null!=(a=this.board[e.c[i]])&&(this.board[e.c[i]]=null,this.zSign=t.zobrist.update(this.zSign,"board",a.s,a.p),a.p=-1,this.pieceCount[1-r]--)}this.lastMoves[this.mWho][2]=this.lastMoves[this.mWho][1],this.lastMoves[this.mWho][1]=this.lastMoves[this.mWho][0],this.lastMoves[this.mWho][0]=new(t.GetMoveClass())(e),this.zSign=t.zobrist.update(this.zSign,"who",-this.mWho),this.zSign=t.zobrist.update(this.zSign,"who",this.mWho)},Model.Board.GetSignature=function(){return this.zSign},Model.Move.PosName={0:"A5",1:"B5",2:"C5",3:"D5",4:"E5",5:"A4",6:"B4",7:"C4",8:"D4",9:"E4",10:"A3",11:"B3",12:"C3",13:"D3",14:"E3",15:"A2",16:"B2",17:"C2",18:"D2",19:"E2",20:"A1",21:"B1",22:"C1",23:"D1",24:"E1"},Model.Board.HuntGameEvaluate=function(t,e,i){this.HuntEvaluateDistToCatcher(t,e,i),this.HuntEvaluateCatcheeGroups(t,e,i),this.HuntEvaluateFreeZone(t,e,i),this.HuntEvaluateRisk(t,e,i);var a=t.mOptions.levelOptions,r={};for(var s in a){var h=/^(.*)(0|1)$/.exec(s);h&&(void 0===r[h[1]]&&(r[h[1]]=[0,0]),r[h[1]][h[2]]=a[s])}return r},Model.Game.InitGame=function(){function t(t,i,a,r){e.g.Graph[t][a]=i,e.g.Graph[i][r]=t}var e=this;this.HuntInitGame(),Object.assign(this.g.huntOptions,{compulsaryCatch:!1,catchLongestLine:!1,multipleCatch:!0}),this.HuntMakeGrid({}),t(10,6,4,5),t(6,2,4,5),t(20,16,4,5),t(16,12,4,5),t(12,8,4,5),t(8,4,4,5),t(22,18,4,5),t(18,14,4,5),t(0,6,6,7),t(6,12,6,7),t(12,18,6,7),t(18,24,6,7),t(10,16,6,7),t(16,22,6,7),t(2,8,6,7),t(8,14,6,7),this.g.catcher=JocGame.PLAYER_B,this.g.evaluate0=-25e5,this.g.catcherMin=1,this.g.catcheeMin=10,this.g.initialPos=[[0,1,2,3,4,5,6,7,8,9,10,14],[12]],this.HuntPostInitGame()};